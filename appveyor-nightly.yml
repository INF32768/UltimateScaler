version: $(VERSION)-alpha (#{build})
skip_non_tags: true
clone_depth: 1
environment:
  JAVA_HOME: C:\Program Files\Java\jdk21
  GITHUB_TOKEN:
    secure: tUvjufRIPG6IV4pB9jRiNUfgD/Heb1TiwBkYJZvnfSOjDqoTu6d843oxOfZdTxsV #有效期至2026-05-28
  PROJECT_NAME: UltimateScaler
  VERSION: 0.4.0-1.21.2
cache:
  - C:\Users\appveyor\.gradle\caches\fabric-loom
  - C:\Users\appveyor\.gradle\caches\modules-2
install:
  - ps: >-
      $ErrorActionPreference = "Stop"\n function Write-Log {\n param([string]$Message)\n $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"\n Write-Host "[$timestamp] $Message"\n }\n function Invoke-GitHubAPI {\n param(\n   [string]$Endpoint,\n   [string]$Method = "GET"\n )\n \n $headers = @{\n   "Authorization" = "token $env:GITHUB_TOKEN"\n   "Accept" = "application/vnd.github.v3+json"\n   "User-Agent" = "PowerShell-CI-Script"\n }\n \n try {\n   $response = Invoke-RestMethod -Uri "https://api.github.com/$Endpoint" `\n   -Method $Method `\n   -Headers $headers `\n   -ContentType "application/json"\n   return $response\n }\n catch {\n   Write-Log "GitHub API调用失败: $($_.Exception.Message)"\n   exit 1\n }\n }\n if ($env:APPVEYOR_REPO_TAG) {\n Write-Log "检测到标签触发: $env:APPVEYOR_REPO_TAG_NAME，跳过每日构建"\n Exit-AppVeyorBuild\n return\n }\n Write-Log "开始构建前验证..."\n Write-Log "查询GitHub仓库分支..."\n $branches = Invoke-GitHubAPI -Endpoint "repos/$env:APPVEYOR_REPO_NAME/branches"\n $targetBranches = $branches | Where-Object {\n $_.name -eq "main" -or \n $_.name -match "^feat/" -or \n $_.name -match "^fix/" -or \n $_.name -match "^refactor/" -or \n $_.name -match "^perf/"\n }\n if ($targetBranches.Count -eq 0) {\n Write-Log "未找到目标分支"\n exit 1\n }\n $latestBranch = $null\n $latestCommitDate = [DateTime]::MinValue\n foreach ($branch in $targetBranches) {\n $commit = Invoke-GitHubAPI -Endpoint "repos/$env:APPVEYOR_REPO_NAME/commits/$($branch.commit.sha)"\n $commitDate = [DateTime]$commit.commit.committer.date\n if ($commitDate -gt $latestCommitDate) {\n   $latestCommitDate = $commitDate\n   $latestBranch = $branch\n }\n }\n if (-not $latestBranch) {\n Write-Log "无法确定最新分支"\n exit 1\n }\n Write-Log "选择分支: $($latestBranch.name) (最新提交: $latestCommitDate)"\n $currentSha = $latestBranch.commit.sha\n Write-Log "当前最新提交SHA: $currentSha"\n $env:CI_TARGET_BRANCH = $latestBranch.name\n $env:CI_TARGET_SHA = $currentSha\n Write-Log "构建验证通过，开始处理分支: $($latestBranch.name)"\n if ($latestBranch.name -eq "main") {\n Write-Log "目标分支为main，无需签出"\n }\n else {\n Write-Log "签出到分支: $($latestBranch.name)"\n git checkout -q $latestBranch.name\n }\n $buildDate = Get-Date -Format "yyyyMMdd"\n $shortSha = $currentSha.Substring(0, 8)\n $nightlyFileName = "{0}-{1}-nightly-{2}-{3}.jar" -f $env:PROJECT_NAME, $env:VERSION, $buildDate, $shortSha\n $env:NIGHTLY_FILENAME = $nightlyFileName\n Write-Log "设置构建产物文件名: $nightlyFileName"\n Write-Log "构建前准备完成，开始构建..."
build_script:
  - cmd: >-
      gradlew build --no-daemon
test_script:
  - ps: >-
      $ErrorActionPreference = "Stop"\n function Write-Log {\n param([string]$Message)\n $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"\n Write-Host "[$timestamp] $Message"\n }\n Write-Log "开始重命名构建产物..."\n if (-not $env:NIGHTLY_FILENAME) {\n Write-Log "错误: NIGHTLY_FILENAME 环境变量未设置"\n exit 1\n }\n if (-not $env:PROJECT_NAME -or -not $env:VERSION) {\n Write-Log "错误: PROJECT_NAME 或 VERSION 环境变量未设置"\n exit 1\n }\n $sourceDir = "build\libs"\n $originalFileName = "{0}-{1}.jar" -f $env:PROJECT_NAME, $env:VERSION\n $sourceFilePath = Join-Path $sourceDir $originalFileName\n $targetFilePath = Join-Path $sourceDir $env:NIGHTLY_FILENAME\n if (-not (Test-Path $sourceFilePath)) {\n Write-Log "警告: 原始文件不存在: $sourceFilePath"\n $possibleFiles = Get-ChildItem -Path $sourceDir -Filter "*.jar" | Where-Object {\n   $_.Name -match "^$([regex]::Escape($env:PROJECT_NAME))-$([regex]::Escape($env:VERSION))"\n }\n if ($possibleFiles.Count -eq 0) {\n   Write-Log "错误: 未找到任何匹配的构建产物"\n   exit 1\n }\n $mainJar = $possibleFiles | Where-Object { $_.Name -match "^$([regex]::Escape($env:PROJECT_NAME))-$([regex]::Escape($env:VERSION))\.jar$" }\n if ($mainJar) {\n   $sourceFilePath = $mainJar.FullName\n   Write-Log "找到主JAR文件: $sourceFilePath"\n }\n else {\n   $sourceFilePath = $possibleFiles[0].FullName\n   Write-Log "使用找到的JAR文件: $sourceFilePath"\n }\n }\n if (-not (Test-Path $sourceDir)) {\n Write-Log "错误: 构建目录不存在: $sourceDir"\n exit 1\n }\n try {\n Write-Log "重命名文件:"\n Write-Log "  从: $(Split-Path $sourceFilePath -Leaf)"\n Write-Log "  到: $(Split-Path $targetFilePath -Leaf)"\n if (Test-Path $targetFilePath) {\n   Remove-Item -Path $targetFilePath -Force\n   Write-Log "已删除已存在的目标文件"\n }\n Rename-Item -Path $sourceFilePath -NewName $env:NIGHTLY_FILENAME -Force\n Write-Log "文件重命名成功"\n $symlinkPath = Join-Path $sourceDir $originalFileName\n if (-not (Test-Path $symlinkPath)) {\n   try {\n New-Item -ItemType SymbolicLink -Path $symlinkPath -Target $targetFilePath -Force | Out-Null\n Write-Log "已创建符号链接: $originalFileName -> $env:NIGHTLY_FILENAME"\n   }\n   catch {\n Write-Log "警告: 无法创建符号链接: $_"\n   }\n }\n $env:NIGHTLY_FILE_PATH = $targetFilePath\n Write-Log "设置文件路径变量: $targetFilePath"\n }\n catch {\n Write-Log "重命名文件失败: $($_.Exception.Message)"\n exit 1\n }\n Write-Log "打包前处理完成"
artifacts:
  - path: $(NIGHTLY_FILE_PATH)
    name: UltimateScaler.jar